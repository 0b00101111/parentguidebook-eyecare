---
import { getCollection } from 'astro:content';
import type { Lang } from '../../i18n/ui';
import { useTranslations } from '../../i18n/utils';
import BaseLayout from '../../layouts/BaseLayout.astro';
import { CATEGORIES, DOMAINS_BY_CATEGORY, EYECARE_DOMAIN } from '../../config/domains';
import { getArticlePath, getBaseSlugFromId } from '../../utils/routes';

export async function getStaticPaths() {
  return [{ params: { lang: 'en' } }, { params: { lang: 'zh' } }];
}

const { lang } = Astro.params as { lang: Lang };
const t = useTranslations(lang);
const canonicalPath = `/${lang}/`;

const all = await getCollection('articles');
const articles = all
  .filter((e) => (lang === 'en' ? e.data.lang === 'en' : e.data.lang === 'zh-Hans'))
  .sort((a, b) => a.data.title.localeCompare(b.data.title));

const byCategory = {
  'emergency-signs': articles.filter((a) => a.data.category === 'emergency-signs'),
  guides: articles.filter((a) => a.data.category === 'guides'),
  'eye-exams': articles.filter((a) => a.data.category === 'eye-exams'),
} as const;

const findBySlug = (slug: string) => articles.find((a) => getBaseSlugFromId(a.id) === slug);
---

<BaseLayout
  lang={lang}
  title="Parent Guidebook"
  description="A free, bilingual guide to raising a whole, healthy, resilient child."
  canonicalPath={canonicalPath}
>
  <section class="landing-hero">
    <h1 class="landing-hero__title">Parent Guidebook</h1>
    <p class="landing-hero__sub">
      {lang === 'en'
        ? 'A free, bilingual guide to raising a whole, healthy, resilient child and caring for all your loved ones.'
        : '一份免费的、双语指南，帮助你在复杂的世界里养育全面、健康、有韧性的孩子，并关爱你所爱的人。'}
    </p>
  </section>

  <section class="landing-section">
    <h2 class="landing-section__title">
      {lang === 'en' ? 'Explore by area' : '按领域浏览'}
    </h2>
    <div class="hub-flat-grid">
      {CATEGORIES.map((cat) => (
        <div class="hub-flat-category">
          <h3 class="hub-flat-category__title">{t(cat.labelKey as any)}</h3>
          <div class="hub-flat-domains">
            {(DOMAINS_BY_CATEGORY[cat.slug] ?? []).map((d) =>
              d.slug === EYECARE_DOMAIN ? (
                <a class="landing-card hub-flat-domain hub-flat-domain--clickable" href="#eyes">
                  <span class="landing-card__title">{t(d.labelKey as any)}</span>
                </a>
              ) : (
                <div class="landing-card landing-card--disabled hub-flat-domain" aria-disabled="true">
                  <span class="landing-card__title">{t(d.labelKey as any)}</span>
                  <span class="landing-card__meta">{t('hub.underConstruction')}</span>
                </div>
              )
            )}
          </div>
        </div>
      ))}
    </div>
  </section>

  <section id="eyes" class="landing-section hub-domain-section">
    <h2 class="landing-section__title">{t('domain.eyes')}</h2>
    <div class="landing-hero landing-hero--in-section">
      <h3 class="landing-hero__title">{t('landing.hero.headline')}</h3>
      <p class="landing-hero__sub">{t('landing.hero.subheadline')}</p>
      <div class="landing-hero__actions">
        <a class="btn-primary" href={getArticlePath(lang, findBySlug('signs-of-vision-problems') ?? articles[0])}>
          {t('landing.hero.cta.start')}
        </a>
        <a class="btn-secondary" href={getArticlePath(lang, findBySlug('eye-exam-schedule') ?? articles[0])}>
          {t('landing.hero.cta.schedule')}
        </a>
      </div>
    </div>
    <h3 class="landing-section__subtitle">{t('landing.featured.title')}</h3>
    <div class="landing-grid">
      {Object.entries(byCategory).map(([cat, list]) => (
        <div class="landing-category">
          <h4 class="landing-category__title">{t(`category.${cat}` as any)}</h4>
          <div class="landing-cards">
            {list.map((a) => (
              <a class="landing-card" href={getArticlePath(lang, a)}>
                <div class="landing-card__category">{t(`category.${a.data.category}` as any)}</div>
                <div class="landing-card__title">{a.data.title}</div>
                <div class="landing-card__meta">{t(`urgency.${a.data.urgency}` as any)}</div>
              </a>
            ))}
          </div>
        </div>
      ))}
    </div>
  </section>
</BaseLayout>
